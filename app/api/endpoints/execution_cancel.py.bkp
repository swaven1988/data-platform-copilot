from __future__ import annotations

from pathlib import Path
from typing import Optional

from fastapi import APIRouter, Header, HTTPException
from pydantic import BaseModel

from app.core.execution.executor import Executor
from app.core.execution.registry import ExecutionRegistry

router = APIRouter(prefix="/api/v2/build", tags=["execution"])


class CancelRequest(BaseModel):
    job_name: str
    workspace_dir: str


@router.post("/cancel", operation_id="v2_cancel_build")
def cancel_build(
    payload: CancelRequest,
    x_tenant: Optional[str] = Header(default=None, alias="X-Tenant"),
):
    _tenant = x_tenant or "default"

    ws = Path(payload.workspace_dir)
    reg = ExecutionRegistry(workspace_dir=ws)
    ex = Executor(registry=reg)

    try:
        rec = ex.cancel(job_name=payload.job_name)
    except ValueError as e:
        raise HTTPException(status_code=404, detail=str(e))

    return {"ok": True, "execution": rec.to_dict(), "tenant": _tenant}