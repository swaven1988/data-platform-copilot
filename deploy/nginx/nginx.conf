upstream api_upstream {
  server api:8001;
}

upstream ui_upstream {
  server ui:8501;
}

server {
  listen 80;

  # API: /api/* -> FastAPI
  location /api/ {
    proxy_set_header Host                  $host;
    proxy_set_header X-Real-IP             $remote_addr;
    proxy_set_header X-Forwarded-For       $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto     $scheme;

    # Ensure auth headers survive reverse proxy
    proxy_set_header Authorization         $http_authorization;
    proxy_set_header X-Forwarded-Authorization $http_authorization;

    proxy_pass http://api_upstream;
  }

  # UI: everything else -> Streamlit
  location / {
    proxy_set_header Host                  $host;
    proxy_set_header X-Real-IP             $remote_addr;
    proxy_set_header X-Forwarded-For       $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto     $scheme;

    proxy_pass http://ui_upstream;
  }
}
