version: "3.9"

services:
  api:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: copilot-api
    expose:
      - "8001"
    environment:
      # ---- Stage 24.1 prod defaults
      COPILOT_ENV: prod
      COPILOT_ALLOW_STATIC_TOKEN_IN_PROD: "true"
      COPILOT_AUTH_MODE: static_token
      COPILOT_AUTH_ENABLED: "true"
      COPILOT_TRUST_PROXY_HEADERS: "true"
      COPILOT_SECURITY_HEADERS_ENABLED: "false"

      # ---- Stage 24.1 rate limiting (app-level)
      COPILOT_RATE_LIMIT_ENABLED: "true"
      COPILOT_RATE_LIMIT_RPM: "120"

      # ---- Stage 24.2 secrets (file-based)
      COPILOT_STATIC_ADMIN_TOKEN_FILE: /run/secrets/admin_token
      COPILOT_STATIC_VIEWER_TOKEN_FILE: /run/secrets/viewer_token
      COPILOT_SIGNING_KEY_FILE: /run/secrets/signing_key
      # ---- AI gateway
      AI_MODEL: "gpt-4o-mini"
      # ---- Build approvals
      COPILOT_HIGH_RISK_APPROVAL_THRESHOLD: "0.70"
      COPILOT_APPROVAL_TTL_SECONDS: "3600"
      # ---- Execution reconciliation
      COPILOT_EXEC_RECONCILE_STALE_SECONDS: "3600"
      COPILOT_EXEC_RECONCILE_INTERVAL_SECONDS: "60"

    secrets:
      - admin_token
      - viewer_token
      - signing_key
      - llm_api_key

    restart: unless-stopped
    tmpfs:
      - /tmp
      - /app/workspace:uid=1000,gid=1000,mode=0775
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "python", "-c",
             "import urllib.request, sys; r=urllib.request.urlopen('http://localhost:8001/api/v1/health/live', timeout=4); sys.exit(0 if r.status==200 else 1)"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3

  web:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: copilot-web
    depends_on:
      api:
        condition: service_healthy
    expose:
      - "80"
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:80/index.html"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  gateway:
    image: nginx:1.27-alpine
    container_name: copilot-gateway
    depends_on:
      api:
        condition: service_healthy
      web:
        condition: service_healthy
    ports:
      - "8080:80"
    volumes:
      - ./nginx/prod-gateway.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    security_opt:
      - no-new-privileges:true

secrets:
  admin_token:
    file: ./secrets/admin_token.txt
  viewer_token:
    file: ./secrets/viewer_token.txt
  signing_key:
    file: ./secrets/signing_key.txt
  llm_api_key:
    file: ./secrets/llm_api_key.txt
