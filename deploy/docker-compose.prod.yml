version: "3.9"

services:
  api:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: copilot-api
    expose:
      - "8001"
    environment:
      COPILOT_AUTH_MODE: static_token
      COPILOT_AUTH_ENABLED: "true"
      COPILOT_STATIC_ADMIN_TOKEN_FILE: /run/secrets/admin_token
      COPILOT_STATIC_VIEWER_TOKEN_FILE: /run/secrets/viewer_token
      COPILOT_SIGNING_KEY: dev_secret_key
      COPILOT_TRUST_PROXY_HEADERS: "true"
    secrets:
      - admin_token
      - viewer_token
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true

  web:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: copilot-web
    depends_on:
      - api
    expose:
      - "80"
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    security_opt:
      - no-new-privileges:true

  gateway:
    image: nginx:1.27-alpine
    container_name: copilot-gateway
    depends_on:
      - api
      - web
    ports:
      - "8080:80"
    volumes:
      - ./nginx/prod-gateway.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    security_opt:
      - no-new-privileges:true

secrets:
  admin_token:
    file: ./secrets/admin_token.txt
  viewer_token:
    file: ./secrets/viewer_token.txt